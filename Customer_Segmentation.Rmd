---
title: "CustomerSegmentation"
output: html_document
date: "2023-04-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(dplyr)
library(ggplot2)
library(GGally)

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
df <- read.csv('./Customer_Data.csv')
df
```

```{r}
sum(is.na(df))
```


## EDA

```{r}
df[duplicated(df)]
```


```{r}
df <- df %>% 
  select(-ID)
```


```{r}
df
```


```{r}
ggplot(df, aes(x=Year_Birth))+ 
     geom_histogram(color = "grey", fill = "#1f77b4", bins = 30)+
  labs(x = "Year of Birth",
       y = "count", 
       title = "Distribution of Birth Year")+
  theme_minimal()

```

```{r}
df %>% 
  filter(Year_Birth < 1930)
```

seems like they are erroneous entries

```{r}
ggplot(df, aes(Marital_Status)) +
  geom_bar(fill = "#1f77b7", alpha = 0.8) + 
  labs( x= "Marital Status",
        y = "count",
        title = "Frequency plot for marital status")+
  theme_minimal()
```

```{r}
ggplot(df, aes(x = Income)) + 
  geom_histogram(fill = "#1f77b7", alpha = 0.8)+ 
  labs(x = "Income",
       y = "Count",
       title = "Distribution of Income")+
  scale_x_continuous(breaks = seq(5000, 100000, by=  40000))+
  theme_minimal()
```
There is an outlier in data where we see a very large income, to see the distribution clearly lets filter our data


```{r}
df %>% 
  filter(Income < 500000) %>% 
  ggplot(aes(x = Income)) + 
  geom_histogram(fill = "#1f77b7", alpha = 0.8)+ 
  labs(x = "Income",
       y = "Count",
       title = "Distribution of Income")+
  scale_x_continuous(breaks = seq(5000, 200000, by=  20000))+
  theme_minimal()
```
There are few data points with income greater than 85000 lets call them high income group while rest looks to in the range 19000 - 70000


```{r fig.width=20}
ggplot(df, aes(x = "", y = Income)) + 
  geom_violin(fill = "#69b3a2", color = "#e9ecef", alpha = 0.8)+
  coord_flip()+
  scale_y_continuous(breaks = seq(5000, 165000, by=  40000))+
  labs(
    x = "Income",
    y = "Distribution",
    title = "Income Distribution"
  )+
  theme_minimal(base_size  = 20)

```


## Inspecting the missing data

```{r}
df[!complete.cases(df),]
```

```{r}
summary(df)
```

The missing values seems to have occurred at random as there are 24 missing values which is 1% of the total data, we can omit those values.


```{r}
df <- na.omit(df)
```

```{r}
sum(is.na(df))
```

Formatting Date column 

```{r}
df %>% 
  select(Dt_Customer)
```

```{r}
df<- df %>% 
  mutate(Dt_Customer = gsub("/", "-", Dt_Customer))
```


```{r}
df<- df %>% 
  mutate(Dt_Customer = as.Date(Dt_Customer, format("%d-%m-%Y")))
```

```{r}
summary(df$Dt_Customer)
```

Calculating Ages by taking the maximum Date


```{r}
df <- df %>% 
  mutate(Age = 2014 - Year_Birth)
```


```{r}
ggplot(df, aes(x = Age)) +
  geom_histogram(fill = "#1f77b7", bins = 40, alpha = 0.8) + 
  labs(x = "Age",
       y = "count",
       title = "Distribution of Age")
```
```{r}
df %>% 
  filter(Income != 666666) %>% 
ggplot(aes(x = Age, y = Income) )+
geom_point(color = "#0072B2", size = 2)+
theme_minimal()
```
There is no any evident pattern 

### Removing Ouliter from data for Income and capping max age to 70

```{r}
df<- df %>% 
  filter(Income != 666666) %>% 
  mutate(Age = ifelse(Age > 70, 70, Age))
```


```{r}
summary(df$Age)
```

```{r}
summary(df$Income)
```

### Checking Correlation between amount of product bought


```{r}
df_product <- df[,c("MntWines","MntFruits", "MntMeatProducts", "MntFishProducts", "MntSweetProducts", "MntGoldProds")]
```


```{r}

library(ggcorrplot)

corr_mat_products <- cor(df_product)

# Create the correlation plot using ggcorrplot
ggcorrplot(corr_mat_products, hc.order = TRUE) +
  theme(plot.title = element_text(hjust = 0.8)) +
  geom_text(aes(label = value)) +
  ggtitle("Correlation Plot of Sample Data")
```

No Correlation Present between products


```{r}
df_gateway <- df[,c("NumDealsPurchases", "NumStorePurchases", "NumWebPurchases", "NumCatalogPurchases", "NumWebVisitsMonth")]
```

```{r}
corr_mat_gtwy <- cor(df_gateway)
```


```{r}
# Create the correlation plot using ggcorrplot
ggcorrplot(corr_mat_gtwy, hc.order = TRUE) +
  theme(plot.title = element_text(hjust = 0.8)) +
  geom_text(aes(label = value)) +
  ggtitle("Correlation Plot of Sample Data")
```
```{r}
df_campaign <- df[,c("AcceptedCmp1", "AcceptedCmp2", "AcceptedCmp3", "AcceptedCmp4", "AcceptedCmp5")]
corr_mat_campaign <- cor(df_campaign)

```


```{r}
ggcorrplot(corr_mat_campaign, hc.order = TRUE) +
  theme(plot.title = element_text(hjust = 0.8)) +
  geom_text(aes(label = value)) +
  ggtitle("Correlation Plot of Sample Data")
```

### Now we examine relation across various columns 

```{r}
df 
```

```{r}
df <- df %>% 
  mutate(Total_Purchaase = MntWines + MntFruits + MntMeatProducts + MntFishProducts + MntSweetProducts + MntSweetProducts + MntGoldProds)
```

```{r}
df %>% 
  group_by(Marital_Status) %>% 
  summarise(Total_Purchase_by_Marital = sum(Total_Purchaase)) %>% 
  ggplot(aes(x = Marital_Status, y = Total_Purchase_by_Marital)) +
  geom_col(fill = "#1f77b7") + 
  theme_minimal()
  
```
We see a graph equivalent to the proportion of the population so there is no particular purchasing more

```{r}
df %>% 
  group_by(Age) %>% 
  summarise(Total_Purchase_by_Marital = sum(Total_Purchaase)) %>% 
  ggplot(aes(x = Age, y = Total_Purchase_by_Marital)) +
  geom_area(fill = "#1f77b7") + 
  theme_minimal()
```

```{r}
df %>% 
  group_by(Income) %>% 
  summarise(Total_Purchase_by_Marital = sum(Total_Purchaase)) %>% 
  ggplot(aes(x = Income, y = Total_Purchase_by_Marital)) +
  geom_point(color = "#1f77b7", size = 2) + 
  theme_minimal()
```
We see a non-linear relationship between Income and Total Purchase 


```{r}
par(mfrow = c(2,1))

df %>% 
  group_by(Education) %>% 
  summarise(Total_Purchase_by_Marital = sum(Total_Purchaase)) %>% 
  ggplot(aes(x = Education, y = Total_Purchase_by_Marital)) +
  geom_col(fill = "#1f77b7") + 
  theme_minimal()+
  labs(x = "Education",
       y = "Total Purchase") 
  
df %>% 
  ggplot(aes(x = Education) )+ 
  geom_bar()
```
Similar proportion in Buying



### Feature Engineering


We Create following features for Data Modelling

1. Age (already Created)
2. Total Purchase (Already Created) : Spending sum on all goods
3. Is_Parent: If customer has kids home
4. Education: Undergraduate, Graduate, Post-Graduate 
5. Has_Partner: If living with someone.
6. Family Size


```{r}
df %>% 
  select(Kidhome, Teenhome)
```

```{r}
df <- df %>% 
  mutate(Is_Parent = ifelse(Kidhome + Teenhome > 0, 1, 0)) 
```


```{r}
df %>% 
  ggplot(aes(x = Is_Parent, y = Total_Purchaase)) +
  geom_col(fill = "#1f77b7")+
  theme_minimal()

df %>% 
  ggplot(aes(Is_Parent) ) +
  geom_bar(fill = "#1f77b7")+
  theme_minimal()

```
We see parents who have kids have spent relative more given then proportion in data.


```{r}
df <- df %>%
  mutate(Education = case_when(
    Education == "Basic" ~ "Undergraduate",
    Education == "2n Cycle" ~ "Undergraduate",
    Education == "Graduation" ~ "Graduate",
    Education == "Master" ~ "Postgraduate",
    Education == "PhD" ~ "Postgraduate",
    TRUE ~ Education  # Keep the original value if none of the above conditions match
  ))
```



```{r}
df %>% 
  ggplot(aes(x = Education, y = Total_Purchaase)) +
  geom_col(fill = "#1f77b7")+
  theme_minimal()


df %>% 
  ggplot(aes(x = Education)) +
  geom_bar()
```

```{r}
df <- df %>%
  mutate(Has_Partner = case_when(
    Marital_Status %in% c("Married", "Together") ~ 1,
    Marital_Status %in% c("Absurd", "Widow", "YOLO", "Divorced", "Single") ~ 0
  ))
```

```{r}
df$Teenhome <- as.integer(df$Teenhome)
df$Kidhome <- as.integer(df$Kidhome)
df$Has_Partner <- as.integer(df$Has_Partner)
```


```{r}
df <- df %>% 
  mutate(Family_Size = Kidhome + Teenhome + Has_Partner)
```

```{r}

```






